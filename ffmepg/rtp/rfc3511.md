# RTP A/V Profile 学习

- [RTP A/V Profile 学习](#rtp-av-profile-学习)
  - [音频](#音频)
    - [编码无关的规则](#编码无关的规则)
    - [操作建议](#操作建议)
    - [基于采样的音频编码指导](#基于采样的音频编码指导)
    - [基于帧的音频编码指导](#基于帧的音频编码指导)
      - [音频编码](#音频编码)
        - [PCMA 和 PCMU](#pcma-和-pcmu)
  - [视频](#视频)
  - [载荷类型定义](#载荷类型定义)
  - [RTP 用 TCP 或类似的字节流协议](#rtp-用-tcp-或类似的字节流协议)
  - [端口赋值](#端口赋值)
  - [参考](#参考)

## 音频

### 编码无关的规则

采样率应该从下面的集合选择：8000、11025、16000、22050、24000、32000、44100 和 48000，单位 Hz。接收者应该准备接收多通道音频，但是可以选择只播放一个通道。

### 操作建议

音频封包，默认封包时间间隔应该是 20ms 时长或一帧，选择较大值，除非单独定义。封包间隔确定了端到端的最小延迟：较大的包使得头域负载变小，但是导致更大的延迟且使得丢包更显著。对于类似演说的非交互式应用或者对带宽要求严苛的链路，可能使用更大的封包延时。接收者应该接受在 0-200ms 的音频数据演示包。

### 基于采样的音频编码指导

在基于采样的编码中，每个音频采样表示为固定比特数。在压缩的音频数据内部，单个采样编码可能超过字节。一个 RTP 音频包可以包含任意数量的音频采样，但是每个采样的比特数乘以每个包的采样数必须生产整数个字节。分数编码生成的每个采样小于一个字节。

一个音频包的时长有每个包的采样数确定。

对于每个采样是 1 或多个字节的采样编码，在同一个时刻不同通道的采样应该被封包在连续的字节。比如，对于双声道的编码，字节序是 (左声道，第一个采样)(右声道，第一个采样)(左声道，第二个采样)(右声道，第二个采样) 等等。对于多字节编码，字节按照网络序传输。

RTP 时间戳反映了包中第一个采样的采样时间，也就是包最旧的信息。

### 基于帧的音频编码指导

基于帧的编码将固定长度的音频块编到另一个压缩数据块，一般也是一个固定长度。对于基于帧的编码，发送者可能选择组合多个这样的帧到一个 RTP 包。如果所有的帧长度相同，通过将 RTP 载荷长度除以音频帧大小(编码定义的一部分)，接收者可以识别 RTP 包的帧数目。当携带不同大小的帧时，除非帧大小是互不相同的，否则这种方法不生效。如果帧大小不同，帧必须标识自己的大小。

对于基于帧的编码，通道顺序的定义作用于整个块。也就是说，对于双声道的音频，右声道和左声道采样应单独编码，生成的帧前一部分是左声道后一部分是右声道。

所有面向帧的音频编码应该可以编码和解码一个包内的多个连续帧。因为面向帧的编码给出了帧大小，不需要为相同的编码单独指定，而是每个包有不同的帧数。

RTP 包应包含整数帧，且一个包内的帧按时间顺序插入，以便最旧的帧(先被播放)在 RTP 头域之后最先出现。RTP 时间戳反映 了第一帧第一个采样数据的时间，也就是包最旧的信息。

#### 音频编码

```txt
name of                              sampling              default
encoding  sample/frame  bits/sample      rate  ms/frame  ms/packet
__________________________________________________________________
DVI4      sample        4                var.                   20
G722      sample        8              16,000                   20
G723      frame         N/A             8,000        30         30
G726-40   sample        5               8,000                   20
G726-32   sample        4               8,000                   20
G726-24   sample        3               8,000                   20
G726-16   sample        2               8,000                   20
G728      frame         N/A             8,000       2.5         20
G729      frame         N/A             8,000        10         20
G729D     frame         N/A             8,000        10         20
G729E     frame         N/A             8,000        10         20
GSM       frame         N/A             8,000        20         20
GSM-EFR   frame         N/A             8,000        20         20
L8        sample        8                var.                   20
L16       sample        16               var.                   20
LPC       frame         N/A             8,000        20         20
MPA       frame         N/A              var.      var.
PCMA      sample        8                var.                   20
PCMU      sample        8                var.                   20
QCELP     frame         N/A             8,000        20         20
VDVI      sample        var.             var.                   20
```

##### PCMA 和 PCMU

音频数据编码在取完对数后为每个采样 8 比特。每个 G.711 字节应该在一个 RTP 包内按字节对齐。每个 G.711 字节的符号位应该和 RTP 包的字节最高有效位一致(比如，假定 G.711 在主机上处理为字节，符号位应该定义为主机格式的最高有效位)。 56kb/s 和 48kb/s 模式的 G.711 不适用于 RTP，因为 PCMA 和 PCMU 必须一个采样 8 比特传输。

## 视频

所有的视频编码使用的 RTP 时间戳频率是 90kHz，和 MPEG4 演示时间戳频率相同。这个频率使得对于一般的
24 (HDTV)、25 (PAL)、29.97 (NTSC) 和 30 Hz (HDTV) 帧率以及 50、59.94 和 60 Hz 帧率都会生成整数的时间差值。

对于大多数视频编码，RTP 时间戳编码的是 RTP 数据包的视频图像的采样时间。如果一个视频图像占用不止一个包，这些包的时间戳都应一样。不同视频图像包通过不同的时间区分。

大多数视频编码也指定了一个视频帧的最后一个包中 RTP 头域的标记位应该设置为 1，否则设置为 0。因此，不需要等待下一个时间戳不同的包来检测是否应该显式为新的一帧。

## 载荷类型定义

96-127 可以在会议控制协议中动态定义。72-76 标记为保留的，以便 RTCP 和 RTP 包可以被可靠区分。

不同媒体类型的载荷类型不应在一个 RTP 会话中交织或复用。

```txt
PT   encoding    media type  clock rate   channels
      name                    (Hz)
___________________________________________________
0    PCMU        A            8,000       1
1    reserved    A
2    reserved    A
3    GSM         A            8,000       1
4    G723        A            8,000       1
5    DVI4        A            8,000       1
6    DVI4        A           16,000       1
7    LPC         A            8,000       1
8    PCMA        A            8,000       1
9    G722        A            8,000       1
10   L16         A           44,100       2
11   L16         A           44,100       1
12   QCELP       A            8,000       1
13   CN          A            8,000       1
14   MPA         A           90,000       (see text)
15   G728        A            8,000       1
16   DVI4        A           11,025       1
17   DVI4        A           22,050       1
18   G729        A            8,000       1
19   reserved    A
20   unassigned  A
21   unassigned  A
22   unassigned  A
23   unassigned  A
dyn  G726-40     A            8,000       1
dyn  G726-32     A            8,000       1
dyn  G726-24     A            8,000       1
dyn  G726-16     A            8,000       1
dyn  G729D       A            8,000       1
dyn  G729E       A            8,000       1
dyn  GSM-EFR     A            8,000       1
dyn  L8          A            var.        var.
dyn  RED         A                        (see text)
dyn  VDVI        A            var.        1
24      unassigned  V
25      CelB        V           90,000
26      JPEG        V           90,000
27      unassigned  V
28      nv          V           90,000
29      unassigned  V
30      unassigned  V
31      H261        V           90,000
32      MPV         V           90,000
33      MP2T        AV          90,000
34      H263        V           90,000
35-71   unassigned  ?
72-76   reserved    N/A         N/A
77-95   unassigned  ?
96-127  dynamic     ?
dyn     H263-1998   V           90,000
```

## RTP 用 TCP 或类似的字节流协议

在一些特殊场景，需要在提供了字节流抽象的协议中携带 RTP，比如 TCP，可能和其他数据复用。应用需要定义自己的方法来描述 RTP 和 RTCP(参考 [RTSP](https://tools.ietf.org/html/rfc3551#ref-23))。

## 端口赋值

RTP 协议定义中指出，RTP 应该使用一个偶数的 UDP 端口号，且对应的 RTCP 应该使用下一个较高的(奇数)端口号。

基于此文档的应用可以使用任意这样的 UDP 端口对。比如，可以由一个会话管理程序随机分配端口对。但是不能要求一个单一固定端口对，因为使用此文档的应用可能运行在同一个主机上，且一些操作系统不允许多个程序使用相同的 UDP 端口和不同的组播地址。

但是，5004 和 5005 是此文档注册的默认端口对。特殊的端口号从 5000 以上选择。

## 参考

- [rfc 3551- RTP Profile for Audio and Video Conferences with Minimal Control](https://tools.ietf.org/html/rfc3551)
